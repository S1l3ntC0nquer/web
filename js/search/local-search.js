window.addEventListener("load",()=>{let t=false;let l=[];const a=document.getElementById("search-mask");function g(e){if(!e)return e;const a=e=>{if(!e)return e;return e.charAt(0).toUpperCase()+e.slice(1)};let l=e.split(" ");l.forEach((e,t)=>{l[t]=a(e)});return l.join(" ")}const e=()=>{const e=document.body.style;e.width="100%";e.overflow="hidden";anzhiyu.animateIn(a,"to_show 0.5s");anzhiyu.animateIn(document.querySelector("#local-search .search-dialog"),"titleScale 0.5s");setTimeout(()=>{document.querySelector("#local-search-input input").focus()},100);if(!t){o();t=true}document.addEventListener("keydown",function e(t){if(t.code==="Escape"){n();document.removeEventListener("keydown",e)}})};const n=()=>{const e=document.body.style;e.width="";e.overflow="";anzhiyu.animateOut(document.querySelector("#local-search .search-dialog"),"search_close .5s");anzhiyu.animateOut(a,"to_hide 0.5s")};const s=()=>{document.querySelector("#search-button > .search").addEventListener("click",e);document.querySelector("#menu-search").addEventListener("click",e)};const r=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",n);a.addEventListener("click",n);if(GLOBAL_CONFIG.localSearch.preload)l=i(GLOBAL_CONFIG.localSearch.path)};const c=e=>{const t=/\.json$/;return t.test(e)};const i=async e=>{let t=[];const a=await fetch(e);if(c(e)){t=await a.json()}else{const l=await a.text();const n=await(new window.DOMParser).parseFromString(l,"text/xml");const s=await n;t=[...s.querySelectorAll("entry")].map(e=>{let a=[];if(e.querySelector("tags")&&e.querySelector("tags").getElementsByTagName("tag")){Array.prototype.forEach.call(e.querySelector("tags").getElementsByTagName("tag"),function(e,t){a.push(e.textContent)})}let t=e.querySelector("content")&&e.querySelector("content").textContent;let l=/<img.*?(?:>|\/>)/gi;let n=/src=[\'\"]?([^\'\"]*)[\'\"]?/i;let s=t.match(l);let r=e.querySelector("cover")&&e.querySelector("cover").textContent;let c=[];if(s){for(let t=0;t<s.length;t++){let e=s[t].match(n);if(!e[1].indexOf("http"))c.push(e[1])}}return{title:e.querySelector("title").textContent,content:t,url:e.querySelector("url").textContent,tags:a,oneImage:r}})}if(a.ok){const r=document.getElementById("loading-database");r.nextElementSibling.style.display="block";r.remove()}return t};const o=()=>{if(!GLOBAL_CONFIG.localSearch.preload){l=i(GLOBAL_CONFIG.localSearch.path)}const e=document.querySelector("#local-search-input input");const t=document.getElementById("local-search-results");const a=document.getElementById("loading-status");e.addEventListener("input",function(){const f=this.value.trim().toLowerCase().split(/[\s]+/);if(f[0]!=="")a.innerHTML='<i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i>';t.innerHTML="";let m='<div class="search-result-list">';if(f.length<=0)return;let y=0;l.then(e=>{e.forEach(e=>{let a=true;let s=e.title?e.title.trim():"";let l=e.title?e.title.trim().toLowerCase():"";let r=e.tags;let c=e.oneImage??"";const i=e.content?e.content.trim().replace(/<[^>]+>/g,"").toLowerCase():"";const o=e.url.startsWith("/")?e.url:GLOBAL_CONFIG.root+e.url;let n=-1;let d=-1;let u=-1;if(l!==""||i!==""){f.forEach((e,t)=>{n=l.indexOf(e);d=i.indexOf(e);if(n<0&&d<0){a=false}else{if(d<0){d=0}if(t===0){u=d}}})}else{a=false}if(a){if(u>=0){let e=u-30;let t=u+100;let a="";let l="";if(e<0){e=0}if(e===0){t=100}else{a="..."}if(t>i.length){t=i.length}else{l="..."}let n=i.substring(e,t);f.forEach(e=>{const t=new RegExp(e,"gi");n=n.replace(t,'<span class="search-keyword">'+e+"</span>");s=s.replace(t,'<span class="search-keyword">'+g(e)+"</span>")});m+='<div class="local-search__hit-item">';if(c){m+=`<div class="search-left"><a href='${o}'"><img src="${c}" data-fancybox='gallery'></a>`}else{m+='<div class="search-left" style="width:0">'}m+="</div>";if(c){m+='<div class="search-right"><a href="'+o+'" class="search-result-title">'+s+"</a>"}else{m+='<div class="search-right" style="width: 100%"><a href="'+o+'" class="search-result-title">'+s+"</a>"}y+=1;if(i!==""){m+='<p class="search-result" onclick="pjax.loadUrl(`'+o+'`)">'+a+n+l+"</p>"}if(r.length){m+='<div class="search-result-tags">';for(let e=0;e<r.length;e++){const h=r[e].trim();m+='<a class="tag-list" href="/tags/'+h+'/" data-pjax-state="" one-link-mark="yes">#'+h+"</a>"}m+="</div>"}}m+="</div></div>"}});if(y===0){m+='<div id="local-search__hits-empty">'+GLOBAL_CONFIG.localSearch.languages.hits_empty.replace(/\$\{query}/,this.value.trim())+"</div>"}m+="</div>";t.innerHTML=m;if(f[0]!=="")a.innerHTML="";window.pjax&&window.pjax.refresh(t)})})};s();r();window.addEventListener("pjax:complete",()=>{!anzhiyu.isHidden(a)&&n();s()})});